<!doctype html>
<html>
<html lang="en">
<head>
	<title>QRoom</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<style>

		* {
	    	box-sizing: border-box;
		}

		body {
	    	font-family: Arial, Helvetica, sans-serif;
		}

		/* Style the header */
		div.header {
		    background-color: #123;
		    line-height: 1px;
		    padding: 10px;
		    text-align: left;
		    font-size: 35px;
		    color: white;
		}

		/* Create three columns/boxes that floats next to each other */
		div.rooms {
		    float: left;
		    width: 25%;
		    height: 500px;
		    background: #ccc;
		    padding: 20px;
		}

		div.queue {
		    float: left;
		    padding: 20px;
		    width: 50%;
		    background-color: #f1f1f1;
		    height: 500px;
		}

		div.playBar {
			width: 0;
			position: relative;
			bottom: -435px;
			height: 25px;
			border-radius: 10px;
			background-color: forestgreen;
			/*animation: playBarAnimation infinite linear;*/
		}

		div.search {
		    float: left;
		    padding: 20px;
		    width: 25%;
		    background-color: #ccc;
		    height: 500px;
		}

		/* Standard syntax */
		@keyframes playBarAnimation {
			0% {width: 0;}
			100% {width: 100%;}
		}

		/* Clear floats after the columns */
		section:after {
		    content: "";
		    display: table;
		    clear: both;
		}

		/* Responsive layout - makes the three columns/boxes stack on top of each other instead of next to each other, on small screens */
		@media (max-width: 600px) {
		    rooms, queue, search {
		        width: 100%;
		        height: 10%;
		    }
		}

		/* styles for vlume switch*/
		.switch {
			position: relative;
            bottom: 45px;
			display: inline-block;
			width: 50px;
			height: 25px;
		}

		/* the off color */
		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			-webkit-transition: .4s;
			transition: .4s;
		}

		/* the embedded square*/
		.slider:before {
			position: absolute;
			content: "";
			height: 19px;
			width: 19px;
			left: 3px;
			bottom: 3px;
			background-color: #f1f1f1;
			-webkit-transition: .4s;
			transition: .4s;
		}

		/* the on color */
		input:checked + .slider {
			background-color: #123;
		}

		input:checked + .slider:before {
			-webkit-transform: translateX(19px);
			-ms-transform: translateX(19px);
			transform: translateX(19px);
		}
	</style>
</head>
	<body onbeforeunload="quit()">
		<div id = "login" >
			<a href = "/login">Click to Login with Spotify</a>
		</div>

		<div id = "loggedin" style="display:none">

		<div id="react_dom"></div>

	</div>

		<!-- Load React. -->
		<!-- Note: when deploying, replace "development.js" with "production.min.js". -->
		<script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
		<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>

		<!-- Load our React component. -->
		<script src="react.js"></script>
		<script id = "name_template" type="text/x-handlebars-template">
				Username : {{display_name}}
		</script>

		<script src="https://sdk.scdn.co/spotify-player.js"></script>
		<script>
			window.onSpotifyWebPlaybackSDKReady = () => {
			const token = getHashParams().token;

			const player = new Spotify.Player({
				name: 'QRoom Player',
				getOAuthToken: cb => { cb(token); }
			});

			// Error handling
			player.addListener('initialization_error', ({ message }) => { console.error("Player message " + message); });
			player.addListener('authentication_error', ({ message }) => { console.error("Player message " + message); });
			player.addListener('account_error', ({ message }) => { console.error("Player message " + message); });
			player.addListener('playback_error', ({ message }) => { console.error("Player message " + message); });

			// Playback status updates
			player.addListener('player_state_changed', state => { /*console.log(state); */});

			// Ready
			player.addListener('ready', ({ device_id }) => {
				console.log('Ready with Device ID', device_id);
				activatePlayer(device_id);
			});

			// Not Ready
			player.addListener('not_ready', ({ device_id }) => {
				console.log('Device ID has gone offline', device_id);
			});

			// Connect to the player!
			player.connect();
		};

		</script>

		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<script>
            var username = null;
			var access_token = null;
			var room_list = null;
			$("#loggedin").hide();
			/**
				parses url hash data into object

				copied from spotify web authorization example
			*/
			function getHashParams() {
				var hashParams = {};
				var e, r = /([^&;=]+)=?([^&;]*)/g,
					q = window.location.hash.substring(1);
				while ( e = r.exec(q)) {
					hashParams[e[1]] = decodeURIComponent(e[2]);
				}
				return hashParams;
			}

			function quit() {
				console.log("Test quit function")
				if(access_token == null){
					return '';
				}
				var dataObject = {
					username : username,
					access_token : access_token
				}
				$.ajax({
					type: 'POST',
					url : '/exit_site',
					data : JSON.stringify(dataObject),
					contentType: 'application/json',
				});
    			return '';
			}

			function layoutStuff(userObject){
				var source= document.getElementById("name_template").innerHTML;
				var template= Handlebars.compile(source);

				document.getElementById("name").innerHTML= template(userObject);
			}

			document.getElementById("showRooms").onclick = function(){showRooms()};

            // getting songs
			$('#songInputForm').submit(function() {
                var title = document.getElementById("songInputForm").elements[0].value;
                searchSong(title);
                //this should prevent page reloading
                return false;
			});

			function searchSong(title){
				title.replace(/ /g, "+");
				const options = {
					url: 'https://api.spotify.com/v1/search?q='+title+'&type=track',
					method: 'GET',
					headers: {
						'Authorization' : 'Bearer ' + access_token
					},
				};

				$.get(options, function(error, response, body){
					layoutSearch(body.responseJSON.tracks, 5);
				});
			}

			//lays out up to n tracks from the tracks object
			function layoutSearch(tracks, n){
				var html = "";

				n= Math.min(n, tracks.items.length);

				for(i= 0; i < n; i++){
					html+= resultButton(tracks.items[i]) + "<br>";
				}

				document.getElementById("search_list").innerHTML= html;
			}

			function resultButton(track){
				return '<button onclick= "playSongCode(\''+track.uri+'\')">'+track.artists[0].name+' : '+track.name+'</button>'
			}

			function playSongCode(songCode){
				var dataObject = {
                    accessToken : access_token,
					songCode : songCode
				}

				$.ajax({
					type: 'POST',
					url : '/addToQueue',
					data : JSON.stringify(dataObject),
					contentType: 'application/json',
				});
			}

			function showRooms() {
				const dataObject = {
					access_token : access_token,
					username: username
				}
                const options= {
                    url: '/getRooms',
                    method: 'GET',
					data: dataObject
                }

                $.get(options, function(error, response, body){
                    layoutRooms(body.responseJSON.available_rooms, body.responseJSON.index);
                    //since body.responseJSON is an array of rooms, save list to the client
                    room_list = body.responseJSON.available_rooms;

                });
            }

			function activatePlayer(device_id){
				$.ajax({
					url: "https://api.spotify.com/v1/me/player",
					method: 'PUT',
					headers: {
						'Authorization' : 'Bearer ' + access_token,
						"Content-Type": "application/json"
					},

					data : JSON.stringify({
						device_ids: [device_id]
					}),

					error : function(message){
						console.log("failed to switch playback");
					},

					success : function(body){
						console.log("switched playback");
					}
				});
			}

			function changeVolume(){
				var volume = document.getElementById("volumeSwitch").checked ? 100 : 0;
				$.ajax({
					url: "https://api.spotify.com/v1/me/player/volume?volume_percent=" + volume,
					method: 'PUT',
					headers: {
						'Authorization' : 'Bearer ' + access_token,
						"Content-Type": "application/json"
					},

					data : JSON.stringify({
						volume_percent : volume
					}),

					error : function(message){
						console.log("failed to change volume");
						console.log(message);
					},

					success : function(body){
						console.log("changed volume");
					}
				});
			}

			if(!access_token){
				var paramObject= getHashParams();
				access_token= paramObject.token;
			}

			//if we have an access token, get our info and display it
			if(access_token){
				const options= {
					url : "https://api.spotify.com/v1/me",
					method : "GET",
					headers : {
						"Authorization" : "Bearer " + access_token
					}
				};

				$.get(options, function(error, response, body){
				    username = body.responseJSON.display_name;
					joinRoom(username, access_token);
					layoutStuff(body.responseJSON);
				});

				window.focus();
				$("#login").hide();
				$("#loggedin").show();
			}

			function joinRoom(username, access_token){
				var dataObject = {
					username : username,
					access_token : access_token
				};

				$.ajax({
					type: 'POST',
					url : '/join_room',
					data : JSON.stringify(dataObject),
					contentType: 'application/json',
					success : function(queueInfo){
						//start polling for the queue
						console.log("joined room");
						pollQueue();

						layoutQueue(queueInfo);
					}
				});
			}

			function pollQueue(){
				const dataObject = {
					access_token : access_token,
					username : username
				}

				$.ajax({
					method: 'GET',
					url: '/pollqueue',
					data: dataObject,
					success: function(queueInfo){
						console.log("Recieved queue");
						layoutQueue(queueInfo);
					},
					error : function(){
						console.log("Timeout or other failure");
						//on a failure, send a get for the queue, to be send immideatly
						getQueue();
					},
					complete : function(){
						pollQueue()
					},
					timeout: 600000
			  })
			}

			function getQueue(){
				const dataObject = {
					access_token : access_token,
				}
				const options = {
					url : '/getqueue',
					type : 'GET',
					data : dataObject
				}
				$.get(options, function(queueInfo){
					layoutQueue(queueInfo);
				});
			}

			function layoutQueue(info){
                // initial songTimer update
                var el = document.getElementById("songBar");
                el.style.animation = "none";
                el.offsetHeight; /* trigger reflow */

                // case: user moves into empty room
				if(info.playing == null){
					document.getElementById("queue").innerHTML= "Empty queue - add a song with the search button";
				}
				else{
                    // if songs are playing, display queue
					var html= "<div>Playing: " + info.playing.artist + ' : ' + info.playing.title + "<div><br>";
					for(i in info.queue){
						html+= getSongDiv(info.queue, i) + "<br>";
					}
					document.getElementById("queue").innerHTML= html;

                    // update songTimer
                    var duration = info.duration/1000;
                    var delayOffset = (Date.now() - info.startTime)/1000;
                    el.style.animation = "playBarAnimation " +
                        duration + "s linear -" + delayOffset + "s";
				}

				//layout members
				console.log("calling layoutMembers");
				layoutMembers(info.clientTokens);
			}

			function layoutMembers(memberObject){
				console.log("member obj: " +memberObject);
				var html= "";
				for(memeber in memberObject){
					html+= memeber + "<br>";
				}

				document.getElementById("users").innerHTML= html;
			}

			function getSongDiv(queue, i){
				song= queue[i];
				var info= song.artist + " : " + song.title;
				var index= parseInt(i)+1;
				return "<div>" + index + ") " + info + "</div>";
			}

            function layoutRooms(rooms, currentIndex) {
                var html = "";
                for (i in rooms) {
					if (i == currentIndex) {
						html += '<button onclick="switchRoom('+i+')" disabled>'+rooms[i].title+'</button><br>';
					}
					else {
						html += '<button onclick="switchRoom('+i+')">'+rooms[i].title+'</button><br>';
					}
                }
                document.getElementById("room_list").innerHTML = html;
            }

            function switchRoom(roomIndex) {
                console.log(room_list[roomIndex]);
                var room = room_list[roomIndex];
                var dataObject = {
                    username : username,
                    accessToken : access_token,
                    // roomIndex is used because there was problems moving a room object from JS to HTML and back to JS
                    moveTo : roomIndex
                };
                $.ajax({
					url : '/moveToRoom',
					type : 'POST',
					data : JSON.stringify(dataObject),
					contentType: 'application/json',
					success : function(data){
						console.log("new room");
						document.getElementById("roomLabel").innerHTML= data.room_name;
						layoutQueue(data.queueInfo);
					}
				});
            }
		</script>
	</body>
</html>
