<!doctype html>
<html>
	<head>
		<title>QRoom</title>
		<style>
			#loggedin {
				display: flex;
			}

			#search_col{
				flex: 40%;
				padding: 10px;
			}
			
			#queue_col{
				flex: 60%;
				padding: 10px;
			}
		</style>
	</head>	
	<body>
		<div id = "login" >
			<a href = "/login">Click to Login with Spotify</a>
		</div>
		<div id = "loggedin">
			<div id= "search_col"> <!-- search column -->
				<button id= "getPlaybackInfo">Get info</button>
				<div id = "name"></div>
				
				<form id="songInputForm">
				  Song search: <input type="text" name="song_search" value="Sunflower"><br>
				</form>
				<button id= "songButton">Search</button>
				
				<div id= "search_list"></div>
			</div> <!-- search column -->
			<div id= "queue_col"> <!-- queue column -->
				<div><u>Queue</u></div><br>
				<div id= "queue"></div>
			</div> <!-- queue column -->
		</div>
		
		<script id = "name_template" type="text/x-handlebars-template">
				Username : {{display_name}}
		</script>
		
		<script src="https://sdk.scdn.co/spotify-player.js"></script>
		<script>
			
			console.log("setting up web player")
			window.onSpotifyWebPlaybackSDKReady = () => {
			  const token = getHashParams().token;

			  const player = new Spotify.Player({
				name: 'Web Playback SDK Quick Start Player',
				getOAuthToken: cb => { cb(token); }
			  });

			  // Error handling
			  player.addListener('initialization_error', ({ message }) => { console.error(message); });
			  player.addListener('authentication_error', ({ message }) => { console.error(message); });
			  player.addListener('account_error', ({ message }) => { console.error(message); });
			  player.addListener('playback_error', ({ message }) => { console.error(message); });

			  // Playback status updates
			  player.addListener('player_state_changed', state => { console.log(state); });

			  // Ready
			  player.addListener('ready', ({ device_id }) => {
				console.log('Ready with Device ID', device_id);
			  });

			  // Not Ready
			  player.addListener('not_ready', ({ device_id }) => {
				console.log('Device ID has gone offline', device_id);
			  });

			  // Connect to the player!
			  player.connect();
			};
			
		</script>
		
		<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script>
			var access_token = null;
			$("#loggedin").hide();
			/**
				parses url hash data into object
				
				copied from spotify web authorization example
			*/
			function getHashParams() {
				var hashParams = {};
				var e, r = /([^&;=]+)=?([^&;]*)/g,
					q = window.location.hash.substring(1);
				while ( e = r.exec(q)) {
					hashParams[e[1]] = decodeURIComponent(e[2]);
				}
				return hashParams;
			}
		
			function layoutStuff(userObject){
				console.log("layoutStuff");
				var source= document.getElementById("name_template").innerHTML;
				var template= Handlebars.compile(source);
				
				document.getElementById("name").innerHTML= template(userObject);
			}
			
			function getPlaybackInfo(){
				const options= {
					url: 'https://api.spotify.com/v1/me/player',
					method: 'GET',
					headers: {
						'Authorization' : 'Bearer ' + access_token
					}
				}
				
				$.get(options, function(error, response, body){
					console.log(body);
					console.log(body.responseJSON)
				});
			}
			
			document.getElementById("getPlaybackInfo").onclick = function(){getPlaybackInfo()};
			document.getElementById("songButton").onclick = function(){
				var title= document.getElementById("songInputForm").elements[0].value;
				searchSong(title);
			};
			
			function searchSong(title){
				console.log("playsongtitle");
				title.replace(/ /g, "+");
				const options = {
					url: 'https://api.spotify.com/v1/search?q='+title+'&type=track',
					method: 'GET',
					headers: {
						'Authorization' : 'Bearer ' + access_token
					},
				}
				
				$.get(options, function(error, response, body){
					layoutSearch(body.responseJSON.tracks, 5);
				});
			}
			
			//lays out up to n tracks from the tracks object
			function layoutSearch(tracks, n){
				console.log(tracks);
				console.log(tracks.items[0].artists[0].name);
				var html = ""
				
				n= Math.min(n, tracks.items.length);
				
				for(i= 0; i < n; i++){
					html+= resultButton(tracks.items[i]) + "<br>";
				}
				
				document.getElementById("search_list").innerHTML= html;
			}
			
			function resultButton(track){
				return '<button onclick= "playSongCode(\''+track.uri+'\')">'+track.artists[0].name+' : '+track.name+'</button>'
			}
			
			function playSongCode(songCode){
				var dataObject = {
					songCode : songCode
				}
				$.get('/addToQueue', dataObject);
			}
			
			if(!access_token){
				var paramObject= getHashParams();
				access_token= paramObject.token;
			}
			
			//if we have an access token, get our info and display it
			if(access_token){
				var username;
				
				const options= {
					url : "https://api.spotify.com/v1/me",
					method : "GET",
					headers : {
						"Authorization" : "Bearer " + access_token
					}
				}
				
				$.get(options, function(error, responce, body){
					joinRoom(body.responseJSON.display_name, access_token);
					layoutStuff(body.responseJSON);
				});
				

				$("#login").hide();
				$("#loggedin").show();
			}
			
			function joinRoom(username, access_token){
				var dataObject = {
					username : username,
					access_token : access_token
				}
				$.get("/join_room", dataObject);
			}
		</script>
		
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
			$(function(){
				var sock= io();
				sock.on("queueUpdate", function(queue){
					layoutQueue(JSON.parse(queue));
				});
			});
			
			var queue= [
				{
					artist : "Pink Floyd",
					title : "Atom Heart Mother"
				},
				{
					artist : "The Beatles",
					title : "Her Majesty"
				},
				{
					artist : "Rex Orange County",
					title : "Sunflower"
				}
			];
			
			function layoutQueue(queue){
				var html= "";
				for(i in queue){
					html+= getSongDiv(queue, i) + "<br>";
				}
				
				document.getElementById("queue").innerHTML= html;
			}
			
			function getSongDiv(queue, i){
				song= queue[i];
				var info= song.artist + " : " + song.title;
				var index= parseInt(i)+1;
				return "<div>" + index + ") " + info + "</div>";
			}
		</script>
		
	</body>
</html>